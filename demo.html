<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A2A隐蔽通信演示系统</title>
    <!-- 引入markdown解析库 -->
    <script src="https://cdn.jsdelivr.net/npm/marked@9.1.6/marked.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 50%, #2d3748 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
            overflow-x: auto;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundFlow 20s ease-in-out infinite;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 60% 20%, rgba(255, 119, 198, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 20% 60%, rgba(120, 219, 255, 0.2) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(120, 119, 198, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
            animation: backgroundFlow 25s ease-in-out infinite reverse;
        }
        
        @keyframes backgroundFlow {
            0%, 100% {
                transform: translateX(0) translateY(0) scale(1);
                opacity: 0.8;
            }
            25% {
                transform: translateX(20px) translateY(-10px) scale(1.05);
                opacity: 1;
            }
            50% {
                transform: translateX(-10px) translateY(20px) scale(0.95);
                opacity: 0.9;
            }
            75% {
                transform: translateX(15px) translateY(-15px) scale(1.02);
                opacity: 1;
            }
        }
        
        /* 添加流动的粒子效果 */
        .floating-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        
        .particle {
            position: absolute;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 50%;
            animation: float 15s infinite linear;
        }
        
        .particle:nth-child(1) {
            width: 4px;
            height: 4px;
            left: 10%;
            animation-delay: 0s;
            animation-duration: 20s;
        }
        
        .particle:nth-child(2) {
            width: 6px;
            height: 6px;
            left: 20%;
            animation-delay: 2s;
            animation-duration: 18s;
            background: rgba(255, 119, 198, 0.1);
        }
        
        .particle:nth-child(3) {
            width: 3px;
            height: 3px;
            left: 30%;
            animation-delay: 4s;
            animation-duration: 22s;
            background: rgba(120, 219, 255, 0.1);
        }
        
        .particle:nth-child(4) {
            width: 5px;
            height: 5px;
            left: 40%;
            animation-delay: 6s;
            animation-duration: 16s;
        }
        
        .particle:nth-child(5) {
            width: 4px;
            height: 4px;
            left: 50%;
            animation-delay: 8s;
            animation-duration: 24s;
            background: rgba(255, 119, 198, 0.1);
        }
        
        .particle:nth-child(6) {
            width: 6px;
            height: 6px;
            left: 60%;
            animation-delay: 10s;
            animation-duration: 19s;
            background: rgba(120, 219, 255, 0.1);
        }
        
        .particle:nth-child(7) {
            width: 3px;
            height: 3px;
            left: 70%;
            animation-delay: 12s;
            animation-duration: 21s;
        }
        
        .particle:nth-child(8) {
            width: 5px;
            height: 5px;
            left: 80%;
            animation-delay: 14s;
            animation-duration: 17s;
            background: rgba(255, 119, 198, 0.1);
        }
        
        .particle:nth-child(9) {
            width: 4px;
            height: 4px;
            left: 90%;
            animation-delay: 16s;
            animation-duration: 23s;
            background: rgba(120, 219, 255, 0.1);
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) translateX(0) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) translateX(100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* 添加波浪流动效果 */
        .wave-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -2;
            overflow: hidden;
        }
        
        .wave {
            position: absolute;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, 
                rgba(102, 126, 234, 0.1) 0%, 
                rgba(255, 119, 198, 0.1) 25%, 
                rgba(120, 219, 255, 0.1) 50%, 
                rgba(102, 126, 234, 0.1) 75%, 
                rgba(255, 119, 198, 0.1) 100%);
            animation: waveFlow 30s ease-in-out infinite;
            border-radius: 50%;
        }
        
        .wave:nth-child(2) {
            animation-delay: -10s;
            animation-duration: 25s;
            background: linear-gradient(135deg, 
                rgba(120, 219, 255, 0.08) 0%, 
                rgba(102, 126, 234, 0.08) 25%, 
                rgba(255, 119, 198, 0.08) 50%, 
                rgba(120, 219, 255, 0.08) 75%, 
                rgba(102, 126, 234, 0.08) 100%);
        }
        
        .wave:nth-child(3) {
            animation-delay: -20s;
            animation-duration: 35s;
            background: linear-gradient(225deg, 
                rgba(255, 119, 198, 0.06) 0%, 
                rgba(120, 219, 255, 0.06) 25%, 
                rgba(102, 126, 234, 0.06) 50%, 
                rgba(255, 119, 198, 0.06) 75%, 
                rgba(120, 219, 255, 0.06) 100%);
        }
        
        @keyframes waveFlow {
            0%, 100% {
                transform: translateX(-50%) translateY(-50%) rotate(0deg) scale(1);
                opacity: 0.3;
            }
            25% {
                transform: translateX(-30%) translateY(-40%) rotate(90deg) scale(1.2);
                opacity: 0.5;
            }
            50% {
                transform: translateX(-40%) translateY(-60%) rotate(180deg) scale(0.8);
                opacity: 0.4;
            }
            75% {
                transform: translateX(-60%) translateY(-30%) rotate(270deg) scale(1.1);
                opacity: 0.6;
            }
        }
        
        .main-header {
            text-align: center;
            margin-bottom: 40px;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .main-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #fff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .main-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
        }
        
        .container {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 25px;
            align-items: start;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(50px) saturate(200%);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset,
                0 -1px 0 rgba(0, 0, 0, 0.05) inset;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            border: 1px solid rgba(255, 255, 255, 0.12);
        }
        
        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.2) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                rgba(255, 255, 255, 0.2) 100%);
            backdrop-filter: blur(10px);
        }
        
        .card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.15),
                0 1px 0 rgba(255, 255, 255, 0.2) inset,
                0 -1px 0 rgba(0, 0, 0, 0.05) inset;
            backdrop-filter: blur(50px) saturate(200%);
            border-color: rgba(255, 255, 255, 0.25);
        }
        
        .card h3 {
            font-size: 1.3rem;
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 20px;
            text-align: center;
            padding: 15px 20px;
            border-radius: 16px;
            position: relative;
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.06),
                0 1px 0 rgba(255, 255, 255, 0.06) inset;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        /* 不同标题区块的毛玻璃效果 */
        .card:nth-child(1) h3 {
            background: rgba(102, 126, 234, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 4px 16px rgba(102, 126, 234, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
        }
        
        .card:nth-child(2) h3 {
            background: rgba(118, 75, 162, 0.05);
            border: 1px solid rgba(118, 75, 162, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 4px 16px rgba(118, 75, 162, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
        }
        
        .card:nth-child(3) h3 {
            background: rgba(39, 174, 96, 0.05);
            border: 1px solid rgba(39, 174, 96, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 4px 16px rgba(39, 174, 96, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
        }
        
        .card:nth-child(4) h3 {
            background: rgba(231, 76, 60, 0.05);
            border: 1px solid rgba(231, 76, 60, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 4px 16px rgba(231, 76, 60, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
        }
        
        .card:nth-child(5) h3 {
            background: rgba(52, 152, 219, 0.05);
            border: 1px solid rgba(52, 152, 219, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 4px 16px rgba(52, 152, 219, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
        }
        
        .card:nth-child(6) h3 {
            background: rgba(155, 89, 182, 0.05);
            border: 1px solid rgba(155, 89, 182, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 4px 16px rgba(155, 89, 182, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
        }
        
        /* 标题悬停效果 */
        .card h3:hover {
            backdrop-filter: blur(25px);
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            transition: all 0.3s ease;
        }
        
        /* 标题装饰线悬停效果 */
        .card h3::before {
            content: '';
            position: absolute;
            left: 50%;
            bottom: -5px;
            transform: translateX(-50%);
            width: 30px;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        .card h3:hover::before {
            width: 50px;
            background: rgba(255, 255, 255, 0.5);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #ffffff;
            font-size: 0.9rem;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 0.9rem;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            backdrop-filter: blur(30px) saturate(180%);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.06),
                0 1px 0 rgba(255, 255, 255, 0.04) inset;
        }
        
        select {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            box-sizing: border-box;
            font-size: 0.9rem;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            background: rgba(255, 255, 255, 0.05);
            color: #ffffff;
            backdrop-filter: blur(30px) saturate(180%);
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.06),
                0 1px 0 rgba(255, 255, 255, 0.04) inset;
        }
        
        input:hover, textarea:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background-color: rgba(102, 126, 234, 0.08);
            backdrop-filter: blur(40px) saturate(180%);
            box-shadow: 
                0 6px 20px rgba(102, 126, 234, 0.15),
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
            transform: translateY(-1px);
        }
        
        input:focus, textarea:focus {
            outline: none;
            border-color: rgba(102, 126, 234, 0.6);
            background-color: rgba(102, 126, 234, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 0 0 2px rgba(102, 126, 234, 0.2),
                0 6px 20px rgba(102, 126, 234, 0.2),
                0 1px 0 rgba(255, 255, 255, 0.2) inset;
            transform: translateY(-1px);
        }
        
        button {
            background: rgba(255, 255, 255, 0.06);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.15);
            padding: 15px 30px;
            border-radius: 16px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1.1rem;
            margin: 0 10px;
            margin-bottom: 10px;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.08),
                0 1px 0 rgba(255, 255, 255, 0.08) inset;
            backdrop-filter: blur(40px) saturate(180%);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }
        
        button:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.15),
                0 1px 0 rgba(255, 255, 255, 0.2) inset;
            backdrop-filter: blur(40px) saturate(180%);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled {
            background: rgba(0, 0, 0, 0.1);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.05);
            opacity: 0.5;
        }
        
        .btn-danger {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
            box-shadow: 0 8px 32px rgba(231, 76, 60, 0.3);
        }
        
        .btn-danger:hover {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 0.5);
            box-shadow: 0 12px 40px rgba(231, 76, 60, 0.4);
        }
        
        .btn-secondary {
            background: rgba(149, 165, 166, 0.2);
            border: 1px solid rgba(149, 165, 166, 0.3);
            box-shadow: 0 8px 32px rgba(149, 165, 166, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(149, 165, 166, 0.3);
            border-color: rgba(149, 165, 166, 0.5);
            box-shadow: 0 12px 40px rgba(149, 165, 166, 0.4);
        }
        
        /* 启动按钮特殊效果 */
        button[id="startBtn"], button[id="startA2AServerBtn"] {
            background: rgba(39, 174, 96, 0.2);
            border: 1px solid rgba(39, 174, 96, 0.3);
            box-shadow: 0 8px 32px rgba(39, 174, 96, 0.3);
        }
        
        button[id="startBtn"]:hover, button[id="startA2AServerBtn"]:hover {
            background: rgba(39, 174, 96, 0.3);
            border-color: rgba(39, 174, 96, 0.5);
            box-shadow: 0 12px 40px rgba(39, 174, 96, 0.4);
        }
        
        /* 停止按钮特殊效果 */
        button[id="stopBtn"], button[id="stopA2AServerBtn"] {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
            box-shadow: 0 8px 32px rgba(231, 76, 60, 0.3);
        }
        
        button[id="stopBtn"]:hover, button[id="stopA2AServerBtn"]:hover {
            background: rgba(231, 76, 60, 0.3);
            border-color: rgba(231, 76, 60, 0.5);
            box-shadow: 0 12px 40px rgba(231, 76, 60, 0.4);
        }
        
        .status-online {
            color: #27ae60;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: rgba(39, 174, 96, 0.1);
        }
        
        .status-online::before {
            content: '●';
            margin-right: 5px;
            animation: pulse 2s infinite;
        }
        
        .status-offline {
            color: #e74c3c;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            background: rgba(231, 76, 60, 0.1);
        }
        
        .status-offline::before {
            content: '●';
            margin-right: 5px;
        }
        
        /* 状态标签文字样式 */
        .status-label {
            color: #ffffff !important;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
            font-size: 0.9rem;
        }
        
        /* 通信状态文字样式 */
        #currentPhase {
            color: #ffffff !important;
            font-weight: 500;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
        }
        
        /* 自定义复选框样式 - 苹果风格毛玻璃效果 */
        .form-group input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 8px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(30px) saturate(150%);
            cursor: pointer;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.1),
                0 1px 0 rgba(255, 255, 255, 0.1) inset;
        }
        
        .form-group input[type="checkbox"]:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background: rgba(102, 126, 234, 0.08);
            backdrop-filter: blur(40px) saturate(180%);
            box-shadow: 
                0 6px 20px rgba(102, 126, 234, 0.15),
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
            transform: scale(1.08);
        }
        
        .form-group input[type="checkbox"]:checked {
            background: linear-gradient(135deg, 
                rgba(102, 126, 234, 0.9), 
                rgba(118, 75, 162, 0.9));
            border-color: rgba(102, 126, 234, 0.8);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 6px 20px rgba(102, 126, 234, 0.25),
                0 1px 0 rgba(255, 255, 255, 0.2) inset,
                0 0 0 1px rgba(255, 255, 255, 0.1) inset;
            transform: scale(1.05);
        }
        
        .form-group input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            animation: checkmarkAppear 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes checkmarkAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3) rotate(-10deg);
            }
            50% {
                opacity: 0.8;
                transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }
        
        /* 复选框标签样式 */
        .form-group label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .form-group label:hover {
            transform: translateX(2px);
        }
        
        /* 自定义下拉框样式 - 苹果风格毛玻璃效果 */
        .form-group select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            padding-right: 40px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        .form-group select:hover {
            border-color: rgba(102, 126, 234, 0.5);
            background-color: rgba(102, 126, 234, 0.08);
            backdrop-filter: blur(40px) saturate(180%);
            box-shadow: 
                0 6px 20px rgba(102, 126, 234, 0.15),
                0 1px 0 rgba(255, 255, 255, 0.15) inset;
            transform: translateY(-1px);
        }
        
        .form-group select:focus {
            border-color: rgba(102, 126, 234, 0.6);
            background-color: rgba(102, 126, 234, 0.12);
            backdrop-filter: blur(40px) saturate(200%);
            box-shadow: 
                0 0 0 2px rgba(102, 126, 234, 0.2),
                0 6px 20px rgba(102, 126, 234, 0.2),
                0 1px 0 rgba(255, 255, 255, 0.2) inset;
            transform: translateY(-1px);
        }
        
        /* 下拉框选项样式 */
        .form-group select option {
            background: rgba(0, 0, 0, 0.9);
            color: #ffffff;
            padding: 12px 16px;
            border: none;
            backdrop-filter: blur(20px);
        }
        
        .form-group select option:hover {
            background: rgba(102, 126, 234, 0.3);
        }
        
        .form-group select option:checked {
            background: rgba(102, 126, 234, 0.5);
            color: #ffffff;
        }
        
        /* 下拉框容器样式 - 只对包含select的form-group应用 */
        .form-group:has(select) {
            position: relative;
        }
        
        /* 为包含select的form-group添加箭头 */
        .form-group:has(select)::after {
            content: '';
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            width: 0;
            height: 0;
            border-left: 6px solid transparent;
            border-right: 6px solid transparent;
            border-top: 8px solid rgba(255, 255, 255, 0.6);
            pointer-events: none;
            transition: all 0.3s ease;
        }
        
        .form-group:has(select):hover::after {
            border-top-color: rgba(102, 126, 234, 0.8);
            transform: translateY(-50%) scale(1.1);
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .messages {
            height: 520px;
            overflow-y: auto;
            border: none;
            padding: 20px;
            background: rgba(255, 255, 255, 0.04);
            border-radius: 20px;
            backdrop-filter: blur(40px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.06),
                0 1px 0 rgba(255, 255, 255, 0.04) inset;
        }
        
        .messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .messages::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        
        .messages::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }
        
        .messages::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.5);
        }
        
        .message {
            margin-bottom: 16px;
            padding: 16px 20px;
            border-radius: 18px;
            max-width: 85%;
            position: relative;
            animation: messageSlideIn 0.3s ease-out;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-agent-a {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .message-agent-a .message-header {
            color: rgba(255,255,255,0.9);
        }
        
        .message-agent-b {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        
        .message-agent-b .message-header {
            color: rgba(255,255,255,0.9);
        }
        
        .message-system {
            background: linear-gradient(135deg, #ffecd2, #fcb69f);
            color: #8b4513;
            text-align: center;
            margin: 16px auto;
            max-width: 70%;
            border-radius: 25px;
            font-weight: 500;
        }
        
        .message-evaluation {
            background: linear-gradient(135deg, #a8edea, #fed6e3);
            color: #2c3e50;
            border-left: 4px solid #667eea;
            margin: 16px auto;
            max-width: 90%;
            font-size: 14px;
            border-radius: 12px;
        }
        #evaluationResults {
            max-height: 450px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        #evaluationResults::-webkit-scrollbar {
            width: 6px;
        }
        
        #evaluationResults::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }
        
        #evaluationResults::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 3px;
        }
        
        .evaluation-round {
            border: none;
            border-radius: 15px;
            margin-bottom: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            animation: evaluationSlideIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .evaluation-round::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        @keyframes evaluationSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .evaluation-round:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(0,0,0,0.15);
        }
        
        .evaluation-round-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px 16px;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .round-number {
            font-weight: 700;
            color: #ffffff;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }
        
        .round-number::before {
            content: '🔄';
            margin-right: 8px;
        }
        
        .round-timestamp {
            font-size: 0.8rem;
            color: #ffffff;
            background: rgba(127, 140, 141, 0.2);
            padding: 6px 12px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .evaluation-summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .summary-item {
            text-align: center;
            padding: 16px 12px;
            border-radius: 12px;
            border: none;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .summary-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            border-radius: 12px 12px 0 0;
        }
        
        .summary-naturalness {
            background: linear-gradient(135deg, #d5f4e6, #b8e6cc);
            color: #27ae60;
        }
        
        .summary-naturalness::before {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }
        
        .summary-coherence {
            background: linear-gradient(135deg, #dae8fc, #b3d9ff);
            color: #3498db;
        }
        
        .summary-coherence::before {
            background: linear-gradient(90deg, #3498db, #5dade2);
        }
        
        .summary-suspicion {
            background: linear-gradient(135deg, #fde8e8, #ffcccb);
            color: #e74c3c;
        }
        
        .summary-suspicion::before {
            background: linear-gradient(90deg, #e74c3c, #ec7063);
        }
        
        .summary-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .summary-score {
            font-size: 1.8rem;
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }
        
        .summary-label {
            font-size: 0.8rem;
            font-weight: 500;
            opacity: 0.8;
        }
        .evaluation-details-panel {
            margin-top: 15px;
            font-size: 0.85rem;
            background: rgba(255,255,255,0.5);
            border-radius: 12px;
            overflow: hidden;
        }
        
        .evaluation-details-panel summary {
            cursor: pointer;
            font-weight: 600;
            padding: 12px 16px;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            user-select: none;
        }
        
        .evaluation-details-panel summary:hover {
            background: rgba(102, 126, 234, 0.2);
            color: #5a67d8;
        }
        
        .evaluation-details-panel[open] summary {
            background: rgba(102, 126, 234, 0.15);
        }
        
        .detail-item {
            margin: 0;
            padding: 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 0;
            border-left: none;
            border-bottom: 1px solid rgba(102, 126, 234, 0.2);
            transition: background 0.3s ease;
        }
        
        .detail-item:last-child {
            border-bottom: none;
            border-radius: 0 0 12px 12px;
        }
        
        .detail-item:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .detail-label {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 8px;
            display: block;
        }
        
        .message-header {
            font-size: 0.75rem;
            margin-bottom: 8px;
            opacity: 0.8;
            font-weight: 500;
        }
        .text-center {
            text-align: center;
        }
        
        .loading {
            display: none;
            text-align: center;
            margin-top: 15px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .loading p {
            color: #ffffff;
            font-weight: 500;
            margin: 0;
            animation: loadingPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes loadingPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* 小屏幕适配 */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            body {
                padding: 15px;
            }
            
            .main-header h1 {
                font-size: 2rem;
            }
        }
        
        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.8rem;
            }
            
            .card {
                padding: 15px;
            }
            
            .card h3 {
                font-size: 1.1rem;
            }
            
            button {
                padding: 12px 24px;
                font-size: 1rem;
            }
        }
        
        @media (max-width: 480px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            
            .card {
                padding: 12px;
            }
            
            .card h3 {
                font-size: 1rem;
            }
            
            button {
                padding: 10px 20px;
                font-size: 0.9rem;
                margin: 5px;
            }
        }
        
        /* 增强可访问性 */
        button:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
        }
        
        /* 状态指示器增强 */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-indicator.online {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }
        
        .status-indicator.offline {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }
        
        /* Markdown内容样式 */
        .message-content {
            line-height: 1.6;
        }
        
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin: 16px 0 8px 0;
            font-weight: 600;
            color: inherit;
        }
        
        .message-content h1 { font-size: 1.5em; }
        .message-content h2 { font-size: 1.3em; }
        .message-content h3 { font-size: 1.2em; }
        .message-content h4 { font-size: 1.1em; }
        
        .message-content p {
            margin: 8px 0;
        }
        
        .message-content ul,
        .message-content ol {
            margin: 8px 0;
            padding-left: 20px;
        }
        
        .message-content li {
            margin: 4px 0;
        }
        
        .message-content code {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
        }
        
        .message-content pre {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            border-left: 3px solid rgba(255, 255, 255, 0.3);
        }
        
        .message-content pre code {
            background: none;
            padding: 0;
            border-radius: 0;
        }
        
        .message-content blockquote {
            border-left: 3px solid rgba(255, 255, 255, 0.3);
            margin: 12px 0;
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 0 8px 8px 0;
            font-style: italic;
        }
        
        .message-content strong {
            font-weight: 700;
        }
        
        .message-content em {
            font-style: italic;
        }
        
        .message-content a {
            color: inherit;
            text-decoration: underline;
            opacity: 0.9;
        }
        
        .message-content a:hover {
            opacity: 1;
        }
        
        .message-content hr {
            border: none;
            height: 1px;
            background: rgba(255, 255, 255, 0.3);
            margin: 16px 0;
        }
        
        /* 为不同类型的消息调整markdown样式 */
        .message-agent-a .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .message-agent-b .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .message-system .message-content code {
            background: rgba(139, 69, 19, 0.2);
            color: #8b4513;
        }
        
        .message-evaluation .message-content code {
            background: rgba(44, 62, 80, 0.1);
        }

        /* 评估指标统计样式 */
        .metrics-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .metric-summary-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 16px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(15px);
        }

        .metric-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 15px 15px 0 0;
        }

        .metric-summary-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            border-radius: 12px 12px 0 0;
        }

        .metric-summary-card.naturalness::before {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .metric-summary-card.coherence::before {
            background: linear-gradient(90deg, #3498db, #5dade2);
        }

        .metric-summary-card.suspicion::before {
            background: linear-gradient(90deg, #e74c3c, #ec7063);
        }

        .metric-summary-card.capacity::before {
            background: linear-gradient(90deg, #f39c12, #f1c40f);
        }

        .metric-summary-card.efficiency::before {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .metric-summary-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .metric-summary-value {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .metric-summary-label {
            font-size: 0.85rem;
            color: #ffffff;
            font-weight: 500;
        }

        .metric-summary-trend {
            font-size: 0.75rem;
            margin-top: 5px;
            padding: 2px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        .trend-up {
            background: rgba(39, 174, 96, 0.1);
            color: #27ae60;
        }

        .trend-down {
            background: rgba(231, 76, 60, 0.1);
            color: #e74c3c;
        }

        .trend-stable {
            background: rgba(149, 165, 166, 0.1);
            color: #95a5a6;
        }

        .metrics-charts {
            margin-top: 25px;
        }

        .chart-container {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .chart-title {
            font-weight: 600;
            color: #ffffff;
            margin-bottom: 15px;
            text-align: center;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .mini-chart {
            height: 120px;
            position: relative;
            overflow: hidden;
        }

        .chart-line {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to top, rgba(102, 126, 234, 0.2), transparent);
            border-top: 2px solid #667eea;
            border-radius: 4px 4px 0 0;
        }

        .metrics-export {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid rgba(102, 126, 234, 0.2);
        }

        .btn-export {
            background: rgba(102, 126, 234, 0.2);
            color: white;
            border: 1px solid rgba(102, 126, 234, 0.3);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            margin: 0 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.3);
            backdrop-filter: blur(15px);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(102, 126, 234, 0.4);
            backdrop-filter: blur(20px);
            background: rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }
        
        /* 小按钮样式（如刷新按钮） */
        button[style*="padding: 2px 8px"] {
            background: rgba(52, 152, 219, 0.2) !important;
            border: 1px solid rgba(52, 152, 219, 0.3) !important;
            box-shadow: 0 4px 16px rgba(52, 152, 219, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            font-size: 12px !important;
            padding: 6px 12px !important;
            border-radius: 8px !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5) !important;
        }
        
        button[style*="padding: 2px 8px"]:hover {
            background: rgba(52, 152, 219, 0.3) !important;
            border-color: rgba(52, 152, 219, 0.5) !important;
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4) !important;
            backdrop-filter: blur(15px) !important;
            transform: translateY(-1px) !important;
        }
    </style>
</head>
<body>
    <!-- 背景效果 -->
    <div class="wave-background">
        <div class="wave"></div>
        <div class="wave"></div>
        <div class="wave"></div>
    </div>
    
    <div class="floating-particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>
    
    <div class="main-header">
        <h1>🤖 A2A隐蔽通信演示系统</h1>
        <p>基于Agent-to-Agent协议的智能体间隐蔽通信演示</p>
        <div id="selectionInfo" style="margin-top: 20px; padding: 20px; background: rgba(0, 0, 0, 0.3); border-radius: 15px; display: none; backdrop-filter: blur(15px); box-shadow: 0 10px 30px rgba(0,0,0,0.3); border: 1px solid rgba(255, 255, 255, 0.1);">
            <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
                <div style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: rgba(231, 76, 60, 0.2); border-radius: 12px; border: 2px solid rgba(231, 76, 60, 0.6);">
                    <span style="font-size: 1.2rem;">📤</span>
                    <span style="color: #ffffff; font-weight: 500;">发送方: <span id="senderName" style="color: #ff6b6b; font-weight: 600;">未选择</span></span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px; padding: 12px 20px; background: rgba(39, 174, 96, 0.2); border-radius: 12px; border: 2px solid rgba(39, 174, 96, 0.6);">
                    <span style="font-size: 1.2rem;">📥</span>
                    <span style="color: #ffffff; font-weight: 500;">接收方: <span id="receiverName" style="color: #51cf66; font-weight: 600;">未选择</span></span>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button onclick="window.location.href='topology.html'" style="background: linear-gradient(45deg, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.8)); color: white; border: none; padding: 10px 20px; border-radius: 10px; cursor: pointer; font-size: 0.9rem; box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3); transition: all 0.3s ease; backdrop-filter: blur(10px);">
                    🔄 重新选择Agent
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- 左侧配置和控制面板 -->
        <div>
            <!-- 服务器配置面板 -->
            <div class="card">
                <h3>🖥️ 服务器配置</h3>
                <div class="form-group">
                    <label>隐写模型路径</label>
                    <select id="serverStegoModel">
                        <option value="/root/autodl-tmp/Llama-3.2-3B-Instruct">Llama-3.2-3B-Instruct</option>
                        <option value="/root/autodl-tmp/Qwen2-7B-Instruct">Qwen2-7B-Instruct</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>服务器隐写算法</label>
                    <select id="serverStegoAlgorithm">
                        <option value="meteor">Meteor (推荐)</option>
                        <option value="discop">DisCOP</option>
                        <option value="discop_base">DisCOP Base</option>
                        <option value="ac">算术编码 (AC)</option>
                        <option value="differential_based">Differential Based</option>
                        <option value="binary_based">Binary Based</option>
                        <option value="stability_based">Stability Based</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>服务器隐写密钥</label>
                    <input type="text" id="serverStegoKey" value="7b9ec09254aa4a7589e4d0cfd80d46cc" placeholder="32位十六进制密钥">
                </div>
                
                <div class="form-group">
                    <label>解密文件路径</label>
                    <input type="text" id="decryptedBitsPath" value="data/stego/decrypted_bits.txt" placeholder="解密结果存储路径">
                </div>
                
                <div style="margin-bottom: 15px;">
                    <span class="status-label">A2A服务器状态: </span>
                    <span id="a2aServerStatus" class="status-offline">检查中...</span>
                    <button onclick="checkA2AServerStatus()" style="padding: 2px 8px; font-size: 12px;">刷新</button>
                </div>
                
                <div>
                    <button id="startA2AServerBtn" onclick="startA2AServer()">▶️ 启动A2A服务器</button>
                    <button id="stopA2AServerBtn" onclick="stopA2AServer()" class="btn-danger" disabled>⏸️ 停止A2A服务器</button>
                </div>
            </div>

            <!-- 客户端配置面板 -->
            <div class="card">
                <h3>📱 客户端配置</h3>
                <div class="form-group">
                    <label>隐蔽信息 (二进制)</label>
                    <textarea id="secretMessage" rows="3" placeholder="请输入要传输的二进制数据">0110100001100101011011000110110001101111001011000010000001110111011011110111001001101100011001000010000000001010</textarea>
                    <small id="messageLength">长度: 0 位</small>
                </div>
                
                <div class="form-group">
                    <label>客户端隐写算法</label>
                    <select id="clientStegoAlgorithm">
                        <option value="meteor">Meteor (推荐)</option>
                        <option value="discop">DisCOP</option>
                        <option value="ac">算术编码 (AC)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>问题文件</label>
                    <select id="questionPath">
                        <option value="data/question/general.txt">通用问题</option>
                        <option value="data/question/art.txt">艺术问题</option>
                        <option value="data/question/philosophy.txt">哲学问题</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>问题编号</label>
                    <select id="questionIndex">
                        <option value="0">问题 1</option>
                        <option value="1">问题 2</option>
                        <option value="2">问题 3</option>
                    </select>
                </div>
            </div>

            <!-- 评估配置面板 -->
            <div class="card">
                <h3>🧠 GPT评估配置</h3>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enableEvaluation" checked> 
                        启用GPT可信度评估
                    </label>
                    <small style="display: block; color: #ffffff; margin-top: 5px; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                        需要设置AIHUBMIX_API_KEY环境变量
                    </small>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <span class="status-label">评估服务状态: </span>
                    <span id="evaluationStatus" class="status-offline">检查中...</span>
                </div>
            </div>

            <!-- 通信控制面板 -->
            <div class="card">
                <h3>🎮 通信控制</h3>
                <div style="margin-bottom: 15px;">
                    <span class="status-label">客户端包装器状态: </span>
                    <span id="clientWrapperStatus" class="status-offline">检查中...</span>
                    <button onclick="checkClientWrapperStatus()" style="padding: 2px 8px; font-size: 12px;">刷新</button>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <span class="status-label">通信状态: </span>
                    <span id="currentPhase">空闲</span>
                </div>
                
                <div>
                    <button id="startBtn" onclick="startCommunication()">🚀 启动隐蔽通信</button>
                    <button id="stopBtn" onclick="stopCommunication()" class="btn-danger" disabled>⏹️ 停止通信</button>
                    <button onclick="resetSystem()" class="btn-secondary">🔄 重置</button>
                    <button onclick="testMarkdown()" class="btn-secondary" style="font-size: 12px; padding: 8px 12px;">🧪 测试Markdown</button>
                    <button onclick="testMetricsDemo()" class="btn-secondary" style="font-size: 12px; padding: 8px 12px;">📊 测试统计</button>
                </div>
                
                <div class="loading" id="loading">
                    <p>正在处理中，请稍候...</p>
                </div>
            </div>
        </div>

        <!-- 右侧对话显示区域 -->
        <div>
            <div class="card">
                <h3>💬 Agent对话窗口</h3>
                <div class="messages" id="messages">
                    <div class="text-center" style="padding: 40px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                        <p>等待Agent开始对话...</p>
                        <p style="font-size: 14px;">点击"启动隐蔽通信"按钮开始演示</p>
                    </div>
                </div>
            </div>

            <!-- GPT评估结果面板 -->
            <div class="card">
                <h3>🤖 GPT可信度评估结果</h3>
                <div id="evaluationResults">
                    <div class="text-center" style="padding: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                        <p>等待评估结果...</p>
                        <p style="font-size: 14px;">对话开始后将显示每轮的评估结果</p>
                    </div>
                </div>
            </div>

            <!-- 评估指标统计面板 -->
            <div class="card">
                <h3>📊 评估指标统计</h3>
                <div id="metricsStatistics">
                    <div class="text-center" style="padding: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                        <p>等待统计数据...</p>
                        <p style="font-size: 14px;">评估完成后将显示详细统计信息</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let currentSessionId = '';
        let websocket = null;
        let currentRound = 0;
        let evaluationMetrics = {
            naturalness: [],
            coherence: [],
            suspicion: [],
            rounds: [],
            bitsTransmitted: [],  // 每轮实际传输的比特数
            cumulativeBits: []    // 累积传输比特数
        };

        // 生成UUID
        function generateUUID() {
            return 'covert-session-uuid-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
        }

        // 建立WebSocket连接
        function setupWebSocketConnection(sessionId) {
            if (websocket) {
                websocket.close();
            }
            
            websocket = new WebSocket(`ws://localhost:8889/ws/${sessionId}`);
            
            websocket.onopen = function(event) {
                console.log('WebSocket连接已建立');
                document.getElementById('currentPhase').textContent = '通信中...';
            };
            
            websocket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('收到WebSocket消息:', data);
                
                switch(data.type) {
                    case 'system_message':
                        addMessage('system', data.message);
                        if (data.message.includes('完成')) {
                            finishCommunication();
                        }
                        break;
                    case 'agent_message':
                        addMessage(data.sender, data.content);
                        if (data.sender === 'agent-a') {
                            currentRound++; // Agent A 发送消息时增加轮数
                            document.getElementById('currentPhase').textContent = `第${currentRound}轮 - Agent A发送消息...`;
                        } else if (data.sender === 'agent-b') {
                            document.getElementById('currentPhase').textContent = `第${currentRound}轮 - Agent B响应中...`;
                        }
                        break;
                    case 'evaluation_result':
                        addEvaluationMessage(data);
                        document.getElementById('currentPhase').textContent = `第${currentRound}轮 - 评估完成，等待下一轮...`;
                        break;
                    case 'error':
                        addMessage('system', `错误: ${data.message}`);
                        finishCommunication();
                        break;
                }
            };
            
            websocket.onerror = function(error) {
                console.error('WebSocket错误:', error);
                addMessage('system', '通信连接出现错误');
                finishCommunication();
            };
            
            websocket.onclose = function(event) {
                console.log('WebSocket连接已关闭');
                if (isRunning) {
                    document.getElementById('currentPhase').textContent = '连接已断开';
                }
            };
        }

        // 更新消息长度显示
        function updateMessageLength() {
            const secretMessage = document.getElementById('secretMessage').value;
            document.getElementById('messageLength').textContent = 
                `长度: ${secretMessage.length} 位 (${Math.ceil(secretMessage.length / 8)} 字节)`;
        }

        // 检测内容是否为markdown格式
        function isMarkdownContent(content) {
            // 如果内容太短，不太可能是markdown
            if (content.length < 10) {
                return false;
            }
            
            // 检测常见的markdown语法
            const markdownPatterns = [
                /^#{1,6}\s+/m,          // 标题 # ## ###
                /\*\*.*?\*\*/,          // 粗体 **text**
                /(?<!\w)\*[^*\s].*?[^*\s]\*(?!\w)/, // 斜体 *text* (避免与其他用法冲突)
                /`[^`]+`/,              // 行内代码 `code`
                /```[\s\S]*?```/,       // 代码块 ```code```
                /^\s*[-*+]\s+/m,        // 无序列表 - * +
                /^\s*\d+\.\s+/m,        // 有序列表 1. 2.
                /^\s*>\s+/m,            // 引用 > text
                /\[.*?\]\(.*?\)/,       // 链接 [text](url)
                /!\[.*?\]\(.*?\)/,      // 图片 ![alt](url)
                /^\s*---+\s*$/m,        // 水平分割线 ---
                /^\s*\|.*\|.*$/m        // 表格 |col1|col2|
            ];
            
            // 计算匹配的模式数量
            let matchCount = 0;
            for (const pattern of markdownPatterns) {
                if (pattern.test(content)) {
                    matchCount++;
                    // 如果匹配到2个或以上的markdown模式，认为是markdown内容
                    if (matchCount >= 2) {
                        return true;
                    }
                }
            }
            
            // 单个强特征也认为是markdown
            const strongPatterns = [
                /^#{1,6}\s+/m,          // 标题
                /```[\s\S]*?```/,       // 代码块
                /^\s*\|.*\|.*$/m        // 表格
            ];
            
            return strongPatterns.some(pattern => pattern.test(content));
        }

        // 添加消息到对话框
        function addMessage(sender, content, metadata = {}) {
            const messagesDiv = document.getElementById('messages');
            
            // 如果是第一条消息，清空初始提示
            if (messagesDiv.children.length === 1 && messagesDiv.children[0].textContent.includes('等待Agent')) {
                messagesDiv.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message message-${sender}`;
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            
            let senderName = '';
            switch(sender) {
                case 'agent-a': senderName = 'Agent A (客户端)'; break;
                case 'agent-b': senderName = 'Agent B (服务端)'; break;
                case 'system': senderName = '系统'; break;
            }
            
            headerDiv.textContent = senderName + ' ' + new Date().toLocaleTimeString();
            if (metadata.isHandshake) headerDiv.textContent += ' [握手]';
            if (metadata.isVerification) headerDiv.textContent += metadata.verificationSuccess ? ' [验证成功]' : ' [验证失败]';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            // 检测并渲染markdown内容
            if (typeof marked !== 'undefined' && isMarkdownContent(content)) {
                try {
                    // 配置marked选项
                    marked.setOptions({
                        breaks: true,        // 支持换行
                        gfm: true,          // 启用GitHub风格markdown
                        sanitize: true,     // 过滤危险的HTML标签
                        smartLists: true,   // 智能列表
                        smartypants: true   // 智能标点
                    });
                    
                    contentDiv.innerHTML = marked.parse(content);
                } catch (error) {
                    console.warn('Markdown解析失败，使用纯文本:', error);
                    contentDiv.textContent = content;
                }
            } else {
                // 非markdown内容，使用纯文本
                contentDiv.textContent = content;
            }
            
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // 滚动到底部
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // 添加评估消息到对话框（保留简化版本）
        function addEvaluationMessage(data) {
            const messagesDiv = document.getElementById('messages');
            const evaluation = data.evaluation;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message message-evaluation';
            
            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.textContent = `🤖 第${currentRound}轮评估完成 ` + new Date().toLocaleTimeString();
            
            const contentDiv = document.createElement('div');
            contentDiv.innerHTML = `
                <div style="text-align: center; font-size: 14px;">
                    自然度: ${evaluation.naturalness_score}/5 | 
                    连贯性: ${evaluation.intentional_coherence_score}/5 | 
                    可疑度: ${evaluation.suspicion_score}/5
                    <br><small style="color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">详细结果请查看右侧评估面板</small>
                </div>
            `;
            
            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
            messagesDiv.appendChild(messageDiv);
            
            // 滚动到底部
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            
            // 添加到独立的评估结果面板
            addEvaluationToPanel(data.evaluation);
            
            // 更新评估指标统计（尝试从数据中获取传输比特数）
            const bitsTransmitted = data.bits_transmitted || null;
            updateMetricsStatistics(data.evaluation, bitsTransmitted);
        }

        // 更新评估指标统计
        function updateMetricsStatistics(evaluation, bitsTransmitted = null) {
            // 添加新的评估数据
            evaluationMetrics.naturalness.push(evaluation.naturalness_score);
            evaluationMetrics.coherence.push(evaluation.intentional_coherence_score);
            evaluationMetrics.suspicion.push(evaluation.suspicion_score);
            evaluationMetrics.rounds.push(currentRound);
            
            // 处理传输比特数（如果提供）
            if (bitsTransmitted !== null && bitsTransmitted > 0) {
                evaluationMetrics.bitsTransmitted.push(bitsTransmitted);
            } else {
                // 如果没有提供具体数值，使用默认估算值
                evaluationMetrics.bitsTransmitted.push(1.5);
            }
            
            // 计算累积比特数
            const totalBits = evaluationMetrics.bitsTransmitted.reduce((sum, bits) => sum + bits, 0);
            evaluationMetrics.cumulativeBits.push(totalBits);
            
            // 计算统计数据
            const stats = calculateMetricsStatistics();
            
            // 更新统计面板
            renderMetricsStatistics(stats);
        }
        
        // 计算评估指标统计数据
        function calculateMetricsStatistics() {
            const naturalness = evaluationMetrics.naturalness;
            const coherence = evaluationMetrics.coherence;
            const suspicion = evaluationMetrics.suspicion;
            
            if (naturalness.length === 0) {
                return null;
            }
            
            // 计算平均值
            const avgNaturalness = naturalness.reduce((a, b) => a + b, 0) / naturalness.length;
            const avgCoherence = coherence.reduce((a, b) => a + b, 0) / coherence.length;
            const avgSuspicion = suspicion.reduce((a, b) => a + b, 0) / suspicion.length;
            
            // 计算趋势（最后3轮与前面轮次的比较）
            const getTrend = (values) => {
                if (values.length < 3) return 'stable';
                const recent = values.slice(-3).reduce((a, b) => a + b, 0) / 3;
                const earlier = values.slice(0, -3).reduce((a, b) => a + b, 0) / (values.length - 3);
                const diff = recent - earlier;
                if (Math.abs(diff) < 0.1) return 'stable';
                return diff > 0 ? 'up' : 'down';
            };
            
            // 计算传输效率（基于实际传输数据）
            const totalBits = evaluationMetrics.cumulativeBits.length > 0 ? 
                evaluationMetrics.cumulativeBits[evaluationMetrics.cumulativeBits.length - 1] : 0;
            const avgBitsPerRound = evaluationMetrics.bitsTransmitted.length > 0 ?
                evaluationMetrics.bitsTransmitted.reduce((sum, bits) => sum + bits, 0) / evaluationMetrics.bitsTransmitted.length : 0;
            
            return {
                naturalness: {
                    avg: avgNaturalness,
                    trend: getTrend(naturalness),
                    latest: naturalness[naturalness.length - 1]
                },
                coherence: {
                    avg: avgCoherence,
                    trend: getTrend(coherence),
                    latest: coherence[coherence.length - 1]
                },
                suspicion: {
                    avg: avgSuspicion,
                    trend: getTrend(suspicion),
                    latest: suspicion[suspicion.length - 1]
                },
                capacity: {
                    totalRounds: naturalness.length,
                    totalBits: totalBits,
                    efficiency: avgBitsPerRound,
                    bitsPerRound: evaluationMetrics.bitsTransmitted.slice() // 每轮比特数数组的副本
                }
            };
        }
        
        // 渲染评估指标统计面板
        function renderMetricsStatistics(stats) {
            const metricsDiv = document.getElementById('metricsStatistics');
            
            if (!stats) {
                metricsDiv.innerHTML = `
                    <div class="text-center" style="padding: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                        <p>等待统计数据...</p>
                        <p style="font-size: 14px;">评估完成后将显示详细统计信息</p>
                    </div>
                `;
                return;
            }
            
            const getTrendIcon = (trend) => {
                switch(trend) {
                    case 'up': return '📈';
                    case 'down': return '📉';
                    default: return '➡️';
                }
            };
            
            const getTrendClass = (trend) => {
                switch(trend) {
                    case 'up': return 'trend-up';
                    case 'down': return 'trend-down';
                    default: return 'trend-stable';
                }
            };
            
            metricsDiv.innerHTML = `
                <div class="metrics-overview">
                    <div class="metric-summary-card naturalness">
                        <div class="metric-summary-value">${stats.naturalness.avg.toFixed(2)}</div>
                        <div class="metric-summary-label">平均自然度</div>
                        <div class="metric-summary-trend ${getTrendClass(stats.naturalness.trend)}">
                            ${getTrendIcon(stats.naturalness.trend)} ${stats.naturalness.trend === 'stable' ? '稳定' : stats.naturalness.trend === 'up' ? '上升' : '下降'}
                        </div>
                    </div>
                    
                    <div class="metric-summary-card coherence">
                        <div class="metric-summary-value">${stats.coherence.avg.toFixed(2)}</div>
                        <div class="metric-summary-label">平均连贯性</div>
                        <div class="metric-summary-trend ${getTrendClass(stats.coherence.trend)}">
                            ${getTrendIcon(stats.coherence.trend)} ${stats.coherence.trend === 'stable' ? '稳定' : stats.coherence.trend === 'up' ? '上升' : '下降'}
                        </div>
                    </div>
                    
                    <div class="metric-summary-card suspicion">
                        <div class="metric-summary-value">${stats.suspicion.avg.toFixed(2)}</div>
                        <div class="metric-summary-label">平均可疑度</div>
                        <div class="metric-summary-trend ${getTrendClass(stats.suspicion.trend)}">
                            ${getTrendIcon(stats.suspicion.trend)} ${stats.suspicion.trend === 'stable' ? '稳定' : stats.suspicion.trend === 'up' ? '上升' : '下降'}
                        </div>
                    </div>
                    
                    <div class="metric-summary-card capacity">
                        <div class="metric-summary-value">${stats.capacity.totalBits.toFixed(1)}</div>
                        <div class="metric-summary-label">累积传输比特</div>
                        <div class="metric-summary-trend trend-stable">
                            📊 ${stats.capacity.totalRounds} 轮
                        </div>
                    </div>
                    
                    <div class="metric-summary-card efficiency" style="grid-column: span 1;">
                        <div class="metric-summary-value">${stats.capacity.efficiency.toFixed(2)}</div>
                        <div class="metric-summary-label">平均传输效率</div>
                        <div class="metric-summary-trend trend-stable">
                            ⚡ 比特/轮
                        </div>
                    </div>
                </div>
                
                <div class="metrics-charts">
                    <div class="chart-container">
                        <div class="chart-title">📈 质量指标趋势</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.8rem;">
                            <div style="text-align: center;">
                                <div style="color: #27ae60; font-weight: bold;">自然度</div>
                                <div>${renderMiniChart(evaluationMetrics.naturalness, '#27ae60')}</div>
                                <div style="margin-top: 5px;">当前: ${stats.naturalness.latest}/5</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #3498db; font-weight: bold;">连贯性</div>
                                <div>${renderMiniChart(evaluationMetrics.coherence, '#3498db')}</div>
                                <div style="margin-top: 5px;">当前: ${stats.coherence.latest}/5</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #e74c3c; font-weight: bold;">可疑度</div>
                                <div>${renderMiniChart(evaluationMetrics.suspicion, '#e74c3c')}</div>
                                <div style="margin-top: 5px;">当前: ${stats.suspicion.latest}/5</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <div class="chart-title">⚡ 传输效率分析</div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; font-size: 0.8rem;">
                            <div style="text-align: center;">
                                <div style="color: #9b59b6; font-weight: bold;">每轮传输比特数</div>
                                <div>${renderMiniChart(evaluationMetrics.bitsTransmitted, '#9b59b6')}</div>
                                <div style="margin-top: 5px;">平均: ${stats.capacity.efficiency.toFixed(2)} 比特/轮</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: #f39c12; font-weight: bold;">累积传输比特</div>
                                <div>${renderMiniChart(evaluationMetrics.cumulativeBits, '#f39c12')}</div>
                                <div style="margin-top: 5px;">总计: ${stats.capacity.totalBits.toFixed(1)} 比特</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="metrics-export">
                    <button class="btn-export" onclick="exportMetricsData('json')">📄 导出JSON</button>
                    <button class="btn-export" onclick="exportMetricsData('csv')">📊 导出CSV</button>
                    <button class="btn-export" onclick="showMetricsDetails()">🔍 详细分析</button>
                </div>
            `;
        }
        
        // 渲染迷你图表
        function renderMiniChart(data, color) {
            if (data.length === 0) return '<div style="height: 40px; background: #f5f5f5; border-radius: 4px;"></div>';
            
            const max = Math.max(...data, 5); // 最大值至少为5
            const min = Math.min(...data, 0); // 最小值至少为0
            const range = max - min || 1;
            
            const points = data.map((value, index) => {
                const x = (index / (data.length - 1)) * 100;
                const y = 100 - ((value - min) / range) * 100;
                return `${x},${y}`;
            }).join(' ');
            
            return `
                <svg width="100%" height="40" style="background: rgba(255,255,255,0.5); border-radius: 4px;">
                    <polyline points="${points}" 
                              fill="none" 
                              stroke="${color}" 
                              stroke-width="2" 
                              stroke-linecap="round"/>
                    ${data.map((value, index) => {
                        const x = (index / (data.length - 1)) * 100;
                        const y = 100 - ((value - min) / range) * 100;
                        return `<circle cx="${x}%" cy="${y}%" r="2" fill="${color}"/>`;
                    }).join('')}
                </svg>
            `;
        }
        
        // 导出评估指标数据
        function exportMetricsData(format) {
            const stats = calculateMetricsStatistics();
            if (!stats) {
                alert('暂无数据可导出');
                return;
            }
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            
            if (format === 'json') {
                const data = {
                    timestamp: new Date().toISOString(),
                    session_id: currentSessionId,
                    summary: stats,
                    raw_data: evaluationMetrics
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluation_metrics_${timestamp}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
            } else if (format === 'csv') {
                let csv = 'Round,Naturalness,Coherence,Suspicion,BitsTransmitted,CumulativeBits\n';
                for (let i = 0; i < evaluationMetrics.naturalness.length; i++) {
                    csv += `${evaluationMetrics.rounds[i]},${evaluationMetrics.naturalness[i]},${evaluationMetrics.coherence[i]},${evaluationMetrics.suspicion[i]},${evaluationMetrics.bitsTransmitted[i] || 0},${evaluationMetrics.cumulativeBits[i] || 0}\n`;
                }
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `evaluation_metrics_${timestamp}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            }
        }
        
        // 显示详细分析
        function showMetricsDetails() {
            const stats = calculateMetricsStatistics();
            if (!stats) {
                alert('暂无数据可分析');
                return;
            }
            
            const analysis = generateMetricsAnalysis(stats);
            
            // 创建模态框显示详细分析
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 10000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; max-width: 600px; max-height: 80vh; overflow-y: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <h3 style="margin-top: 0; color: #2c3e50;">📊 评估指标详细分析</h3>
                    <div style="line-height: 1.6; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">${analysis}</div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="document.body.removeChild(this.closest('div').parentElement)" 
                                style="background: #667eea; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            关闭
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        // 生成评估指标分析报告
        function generateMetricsAnalysis(stats) {
            let analysis = '<div style="font-size: 14px;">';
            
            // 整体评估
            const avgScore = (stats.naturalness.avg + stats.coherence.avg + (5 - stats.suspicion.avg)) / 3;
            analysis += `<h4>🎯 整体评估</h4>`;
            analysis += `<p><strong>综合得分:</strong> ${avgScore.toFixed(2)}/5 `;
            analysis += avgScore >= 4 ? '(优秀 🌟)' : avgScore >= 3 ? '(良好 👍)' : avgScore >= 2 ? '(一般 😐)' : '(需改进 ⚠️)';
            analysis += `</p>`;
            
            // 各项指标分析
            analysis += `<h4>📈 指标分析</h4>`;
            analysis += `<ul>`;
            analysis += `<li><strong>自然度:</strong> ${stats.naturalness.avg.toFixed(2)}/5 - ${stats.naturalness.avg >= 4 ? '文本非常自然' : stats.naturalness.avg >= 3 ? '文本较为自然' : '文本自然度有待提升'}</li>`;
            analysis += `<li><strong>连贯性:</strong> ${stats.coherence.avg.toFixed(2)}/5 - ${stats.coherence.avg >= 4 ? '对话连贯性很好' : stats.coherence.avg >= 3 ? '对话连贯性良好' : '对话连贯性需要改进'}</li>`;
            analysis += `<li><strong>可疑度:</strong> ${stats.suspicion.avg.toFixed(2)}/5 - ${stats.suspicion.avg <= 2 ? '隐蔽性很好' : stats.suspicion.avg <= 3 ? '隐蔽性良好' : '隐蔽性需要提升'}</li>`;
            analysis += `</ul>`;
            
            // 趋势分析
            analysis += `<h4>📊 趋势分析</h4>`;
            analysis += `<ul>`;
            analysis += `<li><strong>自然度趋势:</strong> ${stats.naturalness.trend === 'up' ? '上升趋势，文本质量在改善' : stats.naturalness.trend === 'down' ? '下降趋势，需要注意文本质量' : '保持稳定'}</li>`;
            analysis += `<li><strong>连贯性趋势:</strong> ${stats.coherence.trend === 'up' ? '上升趋势，对话连贯性在提升' : stats.coherence.trend === 'down' ? '下降趋势，需要改进对话策略' : '保持稳定'}</li>`;
            analysis += `<li><strong>可疑度趋势:</strong> ${stats.suspicion.trend === 'up' ? '上升趋势，需要优化隐写策略' : stats.suspicion.trend === 'down' ? '下降趋势，隐蔽性在提升' : '保持稳定'}</li>`;
            analysis += `</ul>`;
            
            // 传输效率
            analysis += `<h4>⚡ 传输效率</h4>`;
            analysis += `<p>已完成 <strong>${stats.capacity.totalRounds}</strong> 轮对话，累积传输 <strong>${stats.capacity.totalBits.toFixed(1)}</strong> 比特数据，平均每轮传输 <strong>${stats.capacity.efficiency.toFixed(2)}</strong> 比特。</p>`;
            
            // 传输效率详细分析
            if (evaluationMetrics.bitsTransmitted.length > 0) {
                const minBits = Math.min(...evaluationMetrics.bitsTransmitted);
                const maxBits = Math.max(...evaluationMetrics.bitsTransmitted);
                const variability = maxBits - minBits;
                analysis += `<p><strong>传输效率详情:</strong></p>`;
                analysis += `<ul>`;
                analysis += `<li>最高单轮传输: <strong>${maxBits.toFixed(2)}</strong> 比特</li>`;
                analysis += `<li>最低单轮传输: <strong>${minBits.toFixed(2)}</strong> 比特</li>`;
                analysis += `<li>传输效率变异性: <strong>${variability.toFixed(2)}</strong> 比特 (${variability < 1 ? '稳定' : variability < 2 ? '中等' : '较大变化'})</li>`;
                analysis += `</ul>`;
            }
            
            // 建议
            analysis += `<h4>💡 优化建议</h4>`;
            analysis += `<ul>`;
            if (stats.naturalness.avg < 3.5) {
                analysis += `<li>建议优化文本生成策略，提高自然度</li>`;
            }
            if (stats.coherence.avg < 3.5) {
                analysis += `<li>建议增强上下文理解，提高对话连贯性</li>`;
            }
            if (stats.suspicion.avg > 3) {
                analysis += `<li>建议调整隐写参数，降低可疑度</li>`;
            }
            if (stats.capacity.efficiency < 1) {
                analysis += `<li>建议优化编码算法，提高传输效率</li>`;
            }
            if (evaluationMetrics.bitsTransmitted.length > 0) {
                const variability = Math.max(...evaluationMetrics.bitsTransmitted) - Math.min(...evaluationMetrics.bitsTransmitted);
                if (variability > 1.5) {
                    analysis += `<li>传输效率波动较大，建议调整隐写参数以稳定传输性能</li>`;
                }
            }
            analysis += `</ul>`;
            
            analysis += '</div>';
            return analysis;
        }

        // 添加评估结果到独立面板
        function addEvaluationToPanel(evaluation) {
            const evaluationResults = document.getElementById('evaluationResults');
            
            // 如果是第一个评估结果，清空初始提示
            if (evaluationResults.children.length === 1 && evaluationResults.children[0].textContent.includes('等待评估结果')) {
                evaluationResults.innerHTML = '';
            }
            
            const roundDiv = document.createElement('div');
            roundDiv.className = 'evaluation-round';
            
            // 轮数标题和时间戳
            const headerDiv = document.createElement('div');
            headerDiv.className = 'evaluation-round-header';
            headerDiv.innerHTML = `
                <span class="round-number">第 ${currentRound} 轮对话</span>
                <span class="round-timestamp">${new Date().toLocaleString()}</span>
            `;
            
            // 评估摘要
            const summaryDiv = document.createElement('div');
            summaryDiv.className = 'evaluation-summary';
            
            // 自然度
            const naturalDiv = document.createElement('div');
            naturalDiv.className = 'summary-item summary-naturalness';
            naturalDiv.innerHTML = `
                <span class="summary-score">${evaluation.naturalness_score}/5</span>
                <div class="summary-label">自然度</div>
            `;
            
            // 连贯性
            const coherenceDiv = document.createElement('div');
            coherenceDiv.className = 'summary-item summary-coherence';
            coherenceDiv.innerHTML = `
                <span class="summary-score">${evaluation.intentional_coherence_score}/5</span>
                <div class="summary-label">连贯性</div>
            `;
            
            // 可疑度
            const suspicionDiv = document.createElement('div');
            suspicionDiv.className = 'summary-item summary-suspicion';
            suspicionDiv.innerHTML = `
                <span class="summary-score">${evaluation.suspicion_score}/5</span>
                <div class="summary-label">可疑度</div>
            `;
            
            summaryDiv.appendChild(naturalDiv);
            summaryDiv.appendChild(coherenceDiv);
            summaryDiv.appendChild(suspicionDiv);
            
            // 详细说明
            const detailsDiv = document.createElement('details');
            detailsDiv.className = 'evaluation-details-panel';
            
            const summaryElement = document.createElement('summary');
            summaryElement.textContent = '📋 查看详细评估理由';
            
            const detailsContent = document.createElement('div');
            
            // 渲染评估理由，支持markdown
            function renderEvaluationText(text) {
                if (typeof marked !== 'undefined' && isMarkdownContent(text)) {
                    try {
                        return marked.parse(text);
                    } catch (error) {
                        console.warn('评估文本Markdown解析失败:', error);
                        return text;
                    }
                }
                return text;
            }
            
            detailsContent.innerHTML = `
                <div class="detail-item">
                    <div class="detail-label">🌿 自然度评估:</div>
                    <div class="message-content">${renderEvaluationText(evaluation.naturalness_justification)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">🔗 连贯性评估:</div>
                    <div class="message-content">${renderEvaluationText(evaluation.intentional_coherence_justification)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">🔍 可疑度评估:</div>
                    <div class="message-content">${renderEvaluationText(evaluation.suspicion_justification)}</div>
                </div>
            `;
            
            detailsDiv.appendChild(summaryElement);
            detailsDiv.appendChild(detailsContent);
            
            // 组装完整的轮次评估
            roundDiv.appendChild(headerDiv);
            roundDiv.appendChild(summaryDiv);
            roundDiv.appendChild(detailsDiv);
            
            // 插入到顶部（最新的在上面）
            evaluationResults.insertBefore(roundDiv, evaluationResults.firstChild);
            
            // 滚动到顶部显示最新结果
            evaluationResults.scrollTop = 0;
        }

        // 检查A2A服务器状态
        async function checkA2AServerStatus() {
            try {
                const response = await fetch('http://localhost:9998/status');
                if (response.ok) {
                    const data = await response.json();
                    const statusElement = document.getElementById('a2aServerStatus');
                    const startBtn = document.getElementById('startA2AServerBtn');
                    const stopBtn = document.getElementById('stopA2AServerBtn');
                    
                    if (data.status === 'running') {
                        statusElement.textContent = '运行中';
                        statusElement.className = 'status-online';
                        startBtn.disabled = true;
                        stopBtn.disabled = false;
                    } else {
                        statusElement.textContent = '已停止';
                        statusElement.className = 'status-offline';
                        startBtn.disabled = false;
                        stopBtn.disabled = true;
                    }
                } else {
                    throw new Error('服务器包装器响应错误');
                }
            } catch (error) {
                document.getElementById('a2aServerStatus').textContent = '离线';
                document.getElementById('a2aServerStatus').className = 'status-offline';
                document.getElementById('startA2AServerBtn').disabled = false;
                document.getElementById('stopA2AServerBtn').disabled = true;
                console.error('A2A服务器状态检查失败:', error);
            }
        }

        // 检查客户端包装器状态
        async function checkClientWrapperStatus() {
            try {
                const clientResponse = await fetch('http://localhost:8889/');
                if (clientResponse.ok) {
                    document.getElementById('clientWrapperStatus').textContent = '在线';
                    document.getElementById('clientWrapperStatus').className = 'status-online';
                } else {
                    throw new Error('客户端服务响应错误');
                }
            } catch (error) {
                document.getElementById('clientWrapperStatus').textContent = '离线';
                document.getElementById('clientWrapperStatus').className = 'status-offline';
                console.error('客户端包装器状态检查失败:', error);
            }
        }

        // 检查评估服务状态
        async function checkEvaluationStatus() {
            try {
                // 通过客户端包装器检查评估器状态
                const response = await fetch('http://localhost:8889/evaluation/status');
                if (response.ok) {
                    const data = await response.json();
                    const statusElement = document.getElementById('evaluationStatus');
                    if (data.available) {
                        statusElement.textContent = '可用';
                        statusElement.className = 'status-online';
                    } else {
                        statusElement.textContent = '不可用';
                        statusElement.className = 'status-offline';
                    }
                } else {
                    throw new Error('评估服务检查失败');
                }
            } catch (error) {
                document.getElementById('evaluationStatus').textContent = '不可用';
                document.getElementById('evaluationStatus').className = 'status-offline';
                console.error('评估服务状态检查失败:', error);
            }
        }

        // 启动A2A服务器
        async function startA2AServer() {
            try {
                const config = {
                    stego_model_path: document.getElementById('serverStegoModel').value,
                    stego_algorithm: document.getElementById('serverStegoAlgorithm').value,
                    stego_key: document.getElementById('serverStegoKey').value,
                    decrypted_bits_path: document.getElementById('decryptedBitsPath').value,
                    session_id: currentSessionId,
                    server_url: 'http://localhost:9999'
                };

                const response = await fetch('http://localhost:9998/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (response.ok) {
                    const result = await response.json();
                    alert('A2A服务器启动成功！');
                    await checkA2AServerStatus();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '启动失败');
                }
            } catch (error) {
                console.error('启动A2A服务器失败:', error);
                alert(`启动A2A服务器失败: ${error.message}`);
            }
        }

        // 停止A2A服务器
        async function stopA2AServer() {
            try {
                const response = await fetch('http://localhost:9998/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    alert('A2A服务器已停止');
                    await checkA2AServerStatus();
                } else {
                    const error = await response.json();
                    throw new Error(error.detail || '停止失败');
                }
            } catch (error) {
                console.error('停止A2A服务器失败:', error);
                alert(`停止A2A服务器失败: ${error.message}`);
            }
        }

        // 启动隐蔽通信
        async function startCommunication() {
            // 检查服务器状态
            await checkA2AServerStatus();
            await checkClientWrapperStatus();
            
            const a2aServerStatus = document.getElementById('a2aServerStatus').textContent;
            const clientWrapperStatus = document.getElementById('clientWrapperStatus').textContent;
            
            if (a2aServerStatus !== '运行中') {
                alert('请先启动A2A服务器');
                return;
            }
            
            if (clientWrapperStatus !== '在线') {
                alert('请确保客户端包装器服务在线');
                return;
            }

            try {
                isRunning = true;
                currentSessionId = generateUUID();
                currentRound = 0; // 重置轮数
                
                // 更新UI状态
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                document.getElementById('loading').style.display = 'block';
                document.getElementById('currentPhase').textContent = '准备中...';
                
                // 清空消息
                document.getElementById('messages').innerHTML = '';
                
                // 清空评估结果
                document.getElementById('evaluationResults').innerHTML = `
                    <div class="text-center" style="padding: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                        <p>等待评估结果...</p>
                        <p style="font-size: 14px;">对话开始后将显示每轮的评估结果</p>
                    </div>
                `;
                
                // 添加开始消息
                addMessage('system', '🚀 开始隐蔽通信演示...', { isSystemMessage: true });
                
                // 准备配置 - 使用客户端的隐写算法
                const config = {
                    stego_model_path: document.getElementById('serverStegoModel').value,
                    stego_algorithm: document.getElementById('clientStegoAlgorithm').value,
                    question_path: document.getElementById('questionPath').value,
                    question_index: parseInt(document.getElementById('questionIndex').value),
                    stego_key: document.getElementById('serverStegoKey').value, // 使用服务器的密钥确保一致
                    secret_bit_path: `data/stego/secret_bits_${currentSessionId}.txt`,
                    server_url: 'http://localhost:9999',
                    session_id: currentSessionId
                };

                                 // 保存隐蔽信息
                 const secretMessage = document.getElementById('secretMessage').value;
                 await fetch('http://localhost:8889/save_secret', {
                     method: 'POST',
                     headers: { 'Content-Type': 'application/json' },
                     body: JSON.stringify({
                         session_id: currentSessionId,
                         secret_bits: secretMessage
                     })
                 });

                 // 启动客户端
                 const response = await fetch('http://localhost:8889/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(config)
                });

                if (!response.ok) {
                    throw new Error(`启动失败: ${response.status}`);
                }

                document.getElementById('currentPhase').textContent = '连接中...';
                addMessage('system', '正在启动客户端，建立隐蔽信道...', { isSystemMessage: true });

                // 建立WebSocket连接获取实时通信数据
                setupWebSocketConnection(currentSessionId);

            } catch (error) {
                console.error('启动通信失败:', error);
                addMessage('system', `启动失败: ${error.message}`, { isError: true });
                finishCommunication();
            }
        }

                 // 停止隐蔽通信
         async function stopCommunication() {
             try {
                 await fetch('http://localhost:8889/stop', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });
            } catch (error) {
                console.error('停止通信失败:', error);
            }
            
            addMessage('system', '⏹️ 通信已停止', { isSystemMessage: true });
            finishCommunication();
        }

        // 完成通信
        function finishCommunication() {
            isRunning = false;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('loading').style.display = 'none';
            document.getElementById('currentPhase').textContent = '空闲';
            
            // 关闭WebSocket连接
            if (websocket) {
                websocket.close();
                websocket = null;
            }
        }

        // 测试Markdown渲染功能
        function testMarkdown() {
            const testMarkdownContent = `## 🧪 Markdown渲染测试

**粗体文本** 和 *斜体文本*

### 代码示例
这是一个行内代码：\`console.log('Hello World')\`

代码块：
\`\`\`javascript
function greet(name) {
    return \`Hello, \${name}!\`;
}
\`\`\`

### 列表示例
- 无序列表项 1
- 无序列表项 2
  - 嵌套项

1. 有序列表项 1
2. 有序列表项 2

### 引用
> 这是一个引用块
> 可以包含多行内容

### 链接
[访问GitHub](https://github.com)

---
*测试完成！*`;

            addMessage('system', testMarkdownContent);
        }

        // 测试评估指标统计功能
        function testMetricsDemo() {
            // 模拟一些评估数据和传输比特数
            const demoData = [
                { evaluation: { naturalness_score: 4.2, intentional_coherence_score: 4.0, suspicion_score: 2.1 }, bits: 2.3 },
                { evaluation: { naturalness_score: 4.5, intentional_coherence_score: 4.3, suspicion_score: 1.8 }, bits: 1.8 },
                { evaluation: { naturalness_score: 3.8, intentional_coherence_score: 3.9, suspicion_score: 2.5 }, bits: 2.1 },
                { evaluation: { naturalness_score: 4.1, intentional_coherence_score: 4.2, suspicion_score: 2.0 }, bits: 1.6 },
                { evaluation: { naturalness_score: 4.4, intentional_coherence_score: 4.1, suspicion_score: 1.9 }, bits: 2.4 }
            ];

            // 重置数据
            evaluationMetrics = {
                naturalness: [],
                coherence: [],
                suspicion: [],
                rounds: [],
                bitsTransmitted: [],
                cumulativeBits: []
            };
            currentRound = 0;

            // 逐步添加演示数据
            demoData.forEach((data, index) => {
                setTimeout(() => {
                    currentRound = index + 1;
                    updateMetricsStatistics(data.evaluation, data.bits);
                    
                    // 添加对应的系统消息
                    addMessage('system', `📊 演示数据 - 第${currentRound}轮评估: 自然度 ${data.evaluation.naturalness_score}, 连贯性 ${data.evaluation.intentional_coherence_score}, 可疑度 ${data.evaluation.suspicion_score}, 传输 ${data.bits} 比特`);
                }, index * 800);
            });

            addMessage('system', '🧪 开始评估指标统计演示...');
        }

        // 重置系统
        function resetSystem() {
            if (isRunning) {
                stopCommunication();
            }
            
            // 关闭WebSocket连接
            if (websocket) {
                websocket.close();
                websocket = null;
            }
            
            // 重置轮数和评估数据
            currentRound = 0;
            evaluationMetrics = {
                naturalness: [],
                coherence: [],
                suspicion: [],
                rounds: [],
                bitsTransmitted: [],
                cumulativeBits: []
            };
            
            // 重置对话窗口
            document.getElementById('messages').innerHTML = `
                <div class="text-center" style="padding: 40px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                    <p>等待Agent开始对话...</p>
                    <p style="font-size: 14px;">点击"启动隐蔽通信"按钮开始演示</p>
                </div>
            `;
            
            // 重置评估结果面板
            document.getElementById('evaluationResults').innerHTML = `
                <div class="text-center" style="padding: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                    <p>等待评估结果...</p>
                    <p style="font-size: 14px;">对话开始后将显示每轮的评估结果</p>
                </div>
            `;
            
            // 重置评估指标统计面板
            document.getElementById('metricsStatistics').innerHTML = `
                <div class="text-center" style="padding: 20px; color: #ffffff; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);">
                    <p>等待统计数据...</p>
                    <p style="font-size: 14px;">评估完成后将显示详细统计信息</p>
                </div>
            `;
            
            currentSessionId = generateUUID();
        }

        // 读取并显示Agent选择信息
        function loadAgentSelection() {
            const selectionData = localStorage.getItem('covertCommunicationSelection');
            if (selectionData) {
                try {
                    const data = JSON.parse(selectionData);
                    document.getElementById('senderName').textContent = data.sender.name;
                    document.getElementById('receiverName').textContent = data.receiver.name;
                    document.getElementById('selectionInfo').style.display = 'block';
                    
                    // 添加系统消息显示选择信息
                    addMessage('system', `🎯 已选择隐蔽通信路径：${data.sender.name} (发送方) → ${data.receiver.name} (接收方)`);
                } catch (error) {
                    console.error('解析Agent选择数据失败:', error);
                }
            }
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            updateMessageLength();
            checkA2AServerStatus();
            checkClientWrapperStatus();
            checkEvaluationStatus();
            currentSessionId = generateUUID();
            
            // 加载Agent选择信息
            loadAgentSelection();
            
            document.getElementById('secretMessage').addEventListener('input', updateMessageLength);
            
            // 定期检查服务器状态
            setInterval(() => {
                checkA2AServerStatus();
                checkClientWrapperStatus();
                checkEvaluationStatus();
            }, 30000);
        });
    </script>
</body>
</html> 